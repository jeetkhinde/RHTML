// File: pages/examples/actions-validation.rhtml
// Purpose: Comprehensive example of actions, validators, and form helpers

use rhtml_macro::Validate;
use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Serialize, Deserialize, Validate)]
struct CreateUserRequest {
    // Basic string validation (auto-trimmed, non-empty)
    name: String,

    // Email validation
    #[email]
    #[no_public_domains]
    email: String,

    // Password validation with strong pattern
    #[password("strong")]
    password: String,

    // Numeric validation
    #[min(18)]
    #[max(120)]
    age: i32,

    // Optional fields (allows empty/whitespace)
    bio: Option<String>,

    // String length validation
    #[min_length(3)]
    #[max_length(50)]
    username: String,

    // URL validation (optional)
    #[url]
    website: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize, Validate)]
struct UpdateUserRequest {
    name: Option<String>,
    email: Option<String>,
    age: Option<i32>,
    bio: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize, Validate)]
struct SearchUsersRequest {
    #[query]
    filter: Option<String>,

    #[query]
    page: Option<i32>,
}

#[derive(Debug, Clone, Serialize)]
struct User {
    id: i32,
    name: String,
    email: String,
    age: i32,
    bio: Option<String>,
    username: String,
}

// Mock database functions
mod db {
    use super::*;

    pub fn get_users() -> Vec<User> {
        vec![
            User {
                id: 1,
                name: "Alice".to_string(),
                email: "alice@company.com".to_string(),
                age: 30,
                bio: Some("Software Engineer".to_string()),
                username: "alice".to_string(),
            },
            User {
                id: 2,
                name: "Bob".to_string(),
                email: "bob@company.com".to_string(),
                age: 25,
                bio: None,
                username: "bob".to_string(),
            },
        ]
    }

    pub fn search_users(filter: Option<String>, _page: i32) -> Vec<User> {
        let all = get_users();
        if let Some(f) = filter {
            all.into_iter()
                .filter(|u| u.name.contains(&f) || u.email.contains(&f))
                .collect()
        } else {
            all
        }
    }

    pub fn get_user(id: i32) -> Option<User> {
        get_users().into_iter().find(|u| u.id == id)
    }

    pub fn create_user(req: CreateUserRequest) -> User {
        User {
            id: 999,
            name: req.name,
            email: req.email,
            age: req.age,
            bio: req.bio,
            username: req.username,
        }
    }

    pub fn update_user(id: i32, req: UpdateUserRequest) -> Option<User> {
        let mut user = get_user(id)?;
        if let Some(name) = req.name {
            user.name = name;
        }
        if let Some(email) = req.email {
            user.email = email;
        }
        if let Some(age) = req.age {
            user.age = age;
        }
        if let Some(bio) = req.bio {
            user.bio = Some(bio);
        }
        Some(user)
    }

    pub fn delete_user(_id: i32) -> bool {
        true
    }

    pub fn count_users() -> i32 {
        get_users().len() as i32
    }
}

css ActionsValidation {
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    label {
        display: block;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    input, textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .error {
        color: #e74c3c;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .success {
        color: #27ae60;
        padding: 1rem;
        background: #d5f4e6;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    button {
        background: #3498db;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background: #2980b9;
    }

    .user-card {
        border: 1px solid #ddd;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }

    .user-count {
        font-weight: bold;
        color: #3498db;
    }
}

#[webpage]
pub fn page() {
    <div class="container">
        <h1>Actions & Validation Example</h1>

        <div id="user-count" class="user-count">
            Total Users: {db::count_users()}
        </div>

        <h2>Create User</h2>
        <form hx-post="/examples/actions-validation" hx-target="#result">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" required />
            </div>

            <div class="form-group">
                <label>Username (3-50 chars)</label>
                <input type="text" name="username" required />
            </div>

            <div class="form-group">
                <label>Email (no public domains)</label>
                <input type="email" name="email" required />
            </div>

            <div class="form-group">
                <label>Password (strong: 8+ chars, upper, lower, number, special)</label>
                <input type="password" name="password" required />
            </div>

            <div class="form-group">
                <label>Age (18-120)</label>
                <input type="number" name="age" required />
            </div>

            <div class="form-group">
                <label>Bio (optional)</label>
                <textarea name="bio"></textarea>
            </div>

            <div class="form-group">
                <label>Website (optional)</label>
                <input type="url" name="website" />
            </div>

            <button type="submit">Create User</button>
        </form>

        <div id="result"></div>

        <h2>Search Users</h2>
        <form hx-get="/examples/actions-validation" hx-target="#user-list">
            <div class="form-group">
                <label>Filter</label>
                <input type="text" name="filter" />
            </div>
            <button type="submit">Search</button>
        </form>

        <div id="user-list">
            <div r-for="user in db::get_users()">
                <div class="user-card" id="user-{user.id}">
                    <h3>{user.name} (@{user.username})</h3>
                    <p>Email: {user.email}</p>
                    <p>Age: {user.age}</p>
                    <div r-if="user.bio.is_some()">
                        <p>Bio: {user.bio.unwrap()}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

/*
// ===== ACTIONS =====
// These would be implemented in the action system:

// GET /examples/actions-validation
fn get_actions_validation(req: SearchUsersRequest) -> Result<Vec<User>, String> {
    let users = db::search_users(
        req.filter,
        req.page.unwrap_or(1)
    );
    Ok(users)
}

// POST /examples/actions-validation
fn post_actions_validation(form: CreateUserRequest) -> Result<ActionResponse<User>, String> {
    // Validation happens automatically via Validate trait
    let user = db::create_user(form);
    Ok(user)
        .toast("User created!")
        .oob("user-count", db::count_users())
}

// PATCH /examples/actions-validation/:id
fn patch_actions_validation(id: i32, form: UpdateUserRequest) -> Result<ActionResponse<User>, String> {
    let user = db::update_user(id, form)
        .ok_or("User not found")?;
    Ok(user).toast("User updated!")
}

// DELETE /examples/actions-validation/:id
fn delete_actions_validation(id: i32) -> Result<Empty, String> {
    db::delete_user(id);
    Empty::new()
        .toast("User deleted!")
        .oob("user-count", db::count_users())
        .build()
}
*/
